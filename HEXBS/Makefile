# ==========================================
#  Verilog é€šç”¨è‡ªå‹•åŒ–è…³æœ¬ (Makefile)
#  é©ç”¨ï¼šIcarus Verilog + GTKWave / WaveTrace
# ==========================================

# 1. è®Šæ•¸è¨­å®š
# æ‰¾å‡ºç•¶å‰è³‡æ–™å¤¾ä¸‹æ‰€æœ‰çš„ .v æª”æ¡ˆ
SRCS = $(wildcard *.v)
# è¨­å®šè¼¸å‡ºåŸ·è¡Œæª”çš„åç¨±
PROJ = simulation
# è¨­å®šæ³¢å½¢æª”åç¨± (å¿…é ˆè·Ÿä½ çš„ testbench $dumpfile è£¡é¢çš„åå­—ä¸€æ¨£)
WAVE = waveform.vcd
# é è¨­ä¸è¼¸å‡ºæ³¢å½¢ï¼Œå¿…è¦æ™‚å¯æ”¹æˆ 1 æˆ–ç”¨ +dump_wave è¦†å¯«
WAVE_DUMP ?= 0
VVP_ARGS ?=
# Icarus ç·¨è­¯æ——æ¨™ (å¯åœ¨é€™è£¡çµ±ä¸€è¨­å®š)
IVERILOG_FLAGS = -g2012 -DWAVEFILE=\"$(WAVE)\" -DENABLE_WAVE_DUMP_DEFAULT=$(WAVE_DUMP)

# 2. ä¸»è¦æŒ‡ä»¤ (è¼¸å…¥ make æœƒåŸ·è¡Œçš„å‹•ä½œ)
# é‚è¼¯ï¼šå…ˆç·¨è­¯(compile) -> å†åŸ·è¡Œ(run)
all: clean compile run

# ç·¨è­¯ï¼šæŠŠæ‰€æœ‰ .v æª”è®Šæˆä¸€å€‹åŸ·è¡Œæª”
compile:
	@echo "ğŸ”¨ Compiling..."
	iverilog -o $(PROJ) $(IVERILOG_FLAGS) $(SRCS)

# åŸ·è¡Œï¼šè·‘æ¨¡æ“¬ï¼Œå¯é€é WAVE_DUMP/VVP_ARGS æ§åˆ¶æ˜¯å¦è¼¸å‡ºæ³¢å½¢
run:
	@echo "ğŸš€ Running Simulation..."
	vvp $(PROJ) $(VVP_ARGS)
	@if [ "$(WAVE_DUMP)" = "1" ] || printf '%s' "$(VVP_ARGS)" | grep -q "dump_wave"; then \
		echo "âœ… Waveform generated: $(WAVE)"; \
	else \
		echo "â„¹ï¸  Waveform dump disabled (use make wave or +dump_wave)."; \
	fi

# é¡å¤–ç›®æ¨™ï¼šé‡å°æ‰€æœ‰æƒ…å¢ƒ (æ³¢å½¢ä¸€å®šè¼¸å‡º)
wave: clean
	@echo "ğŸŒŠ Running with waveform dump enabled (+dump_wave)..."
	$(MAKE) compile WAVE_DUMP=1
	$(MAKE) run WAVE_DUMP=1 VVP_ARGS=+dump_wave

# 3. æ¸…é™¤æŒ‡ä»¤ (è¼¸å…¥ make clean æœƒåŸ·è¡Œçš„å‹•ä½œ)
clean:
	@echo "ğŸ§¹ Cleaning up..."
	rm -f $(PROJ) $(WAVE)

# å½ç›®æ¨™è¨­å®š (é¿å…è³‡æ–™å¤¾å‰›å¥½æœ‰è·ŸæŒ‡ä»¤åŒåçš„æª”æ¡ˆ)
.PHONY: all compile run wave clean
